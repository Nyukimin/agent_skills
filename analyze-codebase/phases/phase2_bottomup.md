# Phase 2: ボトムアップ修正 詳細手順

## 前提条件

Phase 1 の出力が以下に存在すること:
- `docs/codebase-map/modules/` 配下に6つのモジュール解析
- `docs/codebase-map/結合ポイントマップ.md`
- `docs/codebase-map/ユースケース逆引き.md`
- `docs/codebase-map/アーキテクチャ総合.md`

---

## Step 10: フォルダ概要の修正・補強

### 目的
Phase 1 で作成したモジュール解析を実コードと突合せ、抜け漏れ・誤りを修正する。

### 手順

各モジュール解析ファイル（6件）に対して:

1. **Read** でドキュメントを読み込む
2. **serena シンボル解析** で実コードと照合:
   - `get_symbols_overview` で全シンボルを取得し、ドキュメントのナビゲーション・構造マップと比較
   - 大関数の構造マップが正確か確認（case グループ分類、行範囲）
   - 落とし穴・注意点が網羅されているか検証
3. **地図の有用性を検証**:
   - 落とし穴の見落とし（fallthrough, 副作用, 暗黙の前提条件）
   - 構造マップの分類漏れ（未分類の case グループ）
   - モジュール間関係の欠落（ドキュメントにない依存パス）
   - 「読むべき場面」の実用性（実際の開発シーンと一致するか）
4. **【--refs 指定時】設計書との乖離検証**:
   - Phase 0 でマッピングされた設計書を読み込む:
     - .md ファイル: Read ツールで直接読み込む
     - .pdf ファイル: Bash で `pdftotext <file> -` でテキスト取得 + 図のあるページを `pdftoppm -png -r 200 -f N -l N <file> /tmp/pdf_<name>` で PNG 変換し Read で読み込む
   - Phase 1 の「設計意図」セクションと設計書を照合
   - 設計書の図（アーキテクチャ図、フロー図等）と実装のアーキテクチャを比較
   - 仕様と実装の乖離（図との乖離を含む）を「落とし穴・注意点」に追記
   - Phase 1 で「※推測」タグが付いた箇所を設計書で解消
5. **ドキュメントを更新**:
   - 修正箇所に「※Phase 2 で修正」タグを付ける
   - 追加箇所に「※Phase 2 で追加」タグを付ける

### 出力
既存の `docs/codebase-map/modules/` ファイルを上書き更新

---

## Step 11: モジュール概要の修正・補強

### 目的
結合ポイントマップとユースケース逆引きを、Step 10 の修正内容を反映して更新する。

### 手順

1. **Step 10 で更新された全モジュール解析を読み込む**
2. **結合ポイントマップの修正**:
   - 新たに発見された依存関係を追加
   - 誤った依存関係を修正
   - Middleware/Reducer/Observer チェーンの優先度を再確認
3. **ユースケース逆引きの修正**:
   - 処理フローの正確性を実コードと照合
   - 不足しているステップを追加
   - 関数リファレンステーブルの定義場所（行番号）を最新化
4. **更新箇所にタグを付ける**

### 出力
- `docs/codebase-map/結合ポイントマップ.md` を上書き更新
- `docs/codebase-map/ユースケース逆引き.md` を上書き更新

---

## Step 12: 全体概要の最終化

### 目的
全解析結果を統合し、アーキテクチャ総合レポートの最終版を作成する。

### 手順

1. **Phase 1 + Phase 2 の全出力を読み込む**
2. **以下を最終化**:
   - システムアーキテクチャ概要（修正反映）
   - モジュール依存図（修正反映）
   - 主要データフロー（修正反映）
   - Phase 2 で発見された新たな知見セクション
   - 修正影響度チェックリスト（更新）
   - 【--refs 指定時】仕様と実装の乖離サマリ（全モジュール横断）
3. **serena メモリを更新**:
   - `architecture_analysis_summary` を最新版に更新
   - 各モジュールの要約メモリも更新
4. **品質チェック**:
   - 全ドキュメント間の整合性確認
   - 「推測」タグの解消（確認できたものはタグ除去）
   - 未解決の推測は「※未確認」タグに変更

### 出力
- `docs/codebase-map/アーキテクチャ総合.md` を最終版として上書き
- serena メモリ更新

---

## Step 13: 潜在バグ一覧の生成

### 目的
全ドキュメントから潜在バグ・設計書乖離・未実装機能・名前不一致を集約し、一覧ドキュメントを生成する。

### 手順

1. **全モジュール解析（6件）+ アーキテクチャ総合を読み込む**
2. **以下のセクションから項目を抽出**:
   - 「落とし穴・注意点」セクション内の潜在バグ・設計書乖離
   - 「【設計書乖離・Phase 2 PDF検証で追加】」タグの付いた項目
   - 「※Phase 2 で修正」「※Phase 2 で追加」タグの修正のうちバグ性のあるもの
   - アーキテクチャ総合の「修正影響度チェックリスト」「未解決事項」
3. **4カテゴリに分類**:
   - 潜在バグ（コード上の問題）: 深刻度 高/中/低
   - 設計書との乖離: 深刻度 高/中/低/情報
   - 未実装機能
   - 名前不一致・タイポ
4. **各項目に以下を記載**:
   - ID（BUG-001, DEV-001, NI-001, TYPO-001）
   - 深刻度、モジュール、場所（ソースパス:行番号付近）
   - 内容、影響、発見フェーズ
5. **横断分析を追加**:
   - 影響範囲別の優先対応リスト
   - モジュール別集計テーブル
6. **既存調査との重複チェック**:
   - `docs/調査/` の全調査レポートと潜在バグ一覧を照合
   - 既に調査済みの項目には「調査済み: {調査レポートへのリンク}」を付記
   - 調査で原因特定済みの項目は「解決済み」として分類
   - 未調査の項目を優先度高としてハイライト

### 出力
- `docs/codebase-map/modules/潜在バグ一覧.md`
